import{c as g,q as v,o as P,w as h,b as B,d as R,u as I,e as z,f as T,g as S,h as A,s as E,i as $,k as L,r as b,j as s}from"./index-BDAJNNoZ.js";const x=()=>{const e=L();if(!e)throw new Error("Firebase not configured");return e.db},w=()=>{const e=L();if(!(e!=null&&e.auth.currentUser))throw new Error("Not authenticated");return e.auth.currentUser.uid},j={async createProfile(e,o,r){const n=x(),a=R(n,"profiles",e),d={username:o,displayName:r,avatarUrl:"",bio:"",createdAt:E()};return await I(a,d).catch(async()=>{await A(g(n,"profiles"),{...d,id:e})}),{id:e,...d,createdAt:new Date}},async getProfile(e){const o=x(),r=R(o,"profiles",e),n=await $(r);if(!n.exists())throw new Error("Profile not found");return{id:n.id,...n.data()}},async searchUsers(e){const o=x(),r=g(o,"profiles"),n=v(r),a=await S(n),d=[];return a.forEach(c=>{var u,y;const i=c.data(),l=e.toLowerCase();((u=i.username)!=null&&u.toLowerCase().includes(l)||(y=i.displayName)!=null&&y.toLowerCase().includes(l))&&d.push({id:c.id,...i})}),d.slice(0,10)},async sendFriendRequest(e){const o=x(),r=w(),n=g(o,"friendships"),a={userId:r,friendId:e,status:"pending",createdAt:E()};return{id:(await A(n,a)).id,...a,createdAt:new Date}},async acceptFriendRequest(e){const o=x(),r=R(o,"friendships",e);await I(r,{status:"accepted"});const n=await $(r);return{id:n.id,...n.data()}},async getFriends(){const e=x(),o=w(),r=g(e,"friendships"),n=v(r,h("userId","==",o),h("status","==","accepted")),a=await S(n),d=[];for(const c of a.docs){const i=c.data(),l=await this.getProfile(i.friendId).catch(()=>null);d.push({id:c.id,...i,friend:l})}return d},async getPendingRequests(){const e=x(),o=w(),r=g(e,"friendships"),n=v(r,h("friendId","==",o),h("status","==","pending")),a=await S(n),d=[];for(const c of a.docs){const i=c.data(),l=await this.getProfile(i.userId).catch(()=>null);d.push({id:c.id,...i,friend:l})}return d},async sendMessage(e,o,r){const n=x(),a=w(),d=g(n,"messages"),c={senderId:a,receiverId:e,content:o,articleId:r||null,isRead:!1,createdAt:E()};return{id:(await A(d,c)).id,...c,createdAt:new Date}},async getMessages(e){var i;const o=x(),r=w(),n=g(o,"messages"),a=v(n,z(T(h("senderId","==",r),h("receiverId","==",e)),T(h("senderId","==",e),h("receiverId","==",r))),P("createdAt","asc")),d=await S(a),c=[];for(const l of d.docs){const u=l.data();c.push({id:l.id,...u,createdAt:((i=u.createdAt)==null?void 0:i.toDate())||new Date})}return c},async markAsRead(e){const o=x();for(const r of e){const n=R(o,"messages",r);await I(n,{isRead:!0})}},subscribeToMessages(e,o){const r=x(),n=w(),a=g(r,"messages"),d=v(a,h("senderId","==",e),h("receiverId","==",n),P("createdAt","desc"));return B(d,c=>{c.docChanges().forEach(i=>{var l;if(i.type==="added"){const u=i.doc.data();o({id:i.doc.id,...u,createdAt:((l=u.createdAt)==null?void 0:l.toDate())||new Date})}})})}},Q=({article:e,onClose:o})=>{var _,k;const[r,n]=b.useState([]),[a,d]=b.useState(null),[c,i]=b.useState([]),[l,u]=b.useState(""),[y,M]=b.useState(!1),q=b.useRef(null);b.useEffect(()=>{U()},[]),b.useEffect(()=>{if(a){C(a);const t=j.subscribeToMessages(a,f=>{i(m=>[...m,f]),D()});return()=>{t()}}},[a]),b.useEffect(()=>{D()},[c]);const D=()=>{var t;(t=q.current)==null||t.scrollIntoView({behavior:"smooth"})},U=async()=>{try{const t=await j.getFriends();n(t)}catch(t){console.error("Error loading friends:",t)}},C=async t=>{try{M(!0);const f=await j.getMessages(t);i(f);const m=f.filter(N=>!N.is_read&&N.receiver_id!==t).map(N=>N.id);m.length>0&&await j.markAsRead(m)}catch(f){console.error("Error loading messages:",f)}finally{M(!1)}},F=async()=>{if(!(!l.trim()||!a))try{const t=e?`شارك معك خبر: "${e.headline}"

${l}`:l;await j.sendMessage(a,t,e==null?void 0:e.id),u(""),await C(a)}catch(t){console.error("Error sending message:",t)}},p=r.find(t=>t.friend_id===a);return s.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:s.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-4xl h-[600px] flex overflow-hidden",children:[s.jsxs("div",{className:"w-1/3 border-r border-slate-200 flex flex-col",children:[s.jsxs("div",{className:"p-4 border-b border-slate-200 flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700",children:[s.jsx("h3",{className:"font-bold text-white",children:"الأصدقاء / Friends"}),s.jsx("button",{onClick:o,className:"text-white hover:text-slate-200 text-2xl",children:"×"})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:r.length===0?s.jsxs("div",{className:"p-4 text-center text-slate-500",children:["لا يوجد أصدقاء بعد",s.jsx("br",{}),"No friends yet"]}):r.map(t=>{var f,m;return s.jsxs("button",{onClick:()=>d(t.friend_id),className:`w-full p-4 text-right hover:bg-slate-50 transition-colors border-b border-slate-100 ${a===t.friend_id?"bg-blue-50":""}`,children:[s.jsx("div",{className:"font-semibold text-slate-800",children:(f=t.friend)==null?void 0:f.display_name}),s.jsxs("div",{className:"text-sm text-slate-500",children:["@",(m=t.friend)==null?void 0:m.username]})]},t.id)})})]}),s.jsx("div",{className:"flex-1 flex flex-col",children:a?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"p-4 border-b border-slate-200 bg-slate-50",children:[s.jsx("div",{className:"font-bold text-slate-800",children:(_=p==null?void 0:p.friend)==null?void 0:_.display_name}),s.jsxs("div",{className:"text-sm text-slate-500",children:["@",(k=p==null?void 0:p.friend)==null?void 0:k.username]})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[y?s.jsx("div",{className:"text-center text-slate-500",children:"جاري التحميل..."}):c.length===0?s.jsxs("div",{className:"text-center text-slate-500",children:["ابدأ المحادثة!",s.jsx("br",{}),"Start the conversation!"]}):c.map(t=>{const f=t.sender_id!==a;return s.jsx("div",{className:`flex ${f?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[70%] rounded-lg p-3 ${f?"bg-blue-600 text-white":"bg-slate-100 text-slate-800"}`,children:[s.jsx("div",{className:"whitespace-pre-wrap",children:t.content}),s.jsx("div",{className:`text-xs mt-1 ${f?"text-blue-100":"text-slate-500"}`,children:new Date(t.created_at).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})})]})},t.id)}),s.jsx("div",{ref:q})]}),e&&s.jsxs("div",{className:"px-4 py-2 border-t border-slate-200 bg-blue-50",children:[s.jsx("div",{className:"text-xs text-slate-600 mb-1",children:"سيتم مشاركة هذا الخبر:"}),s.jsx("div",{className:"text-sm font-semibold text-slate-800 truncate",children:e.headline})]}),s.jsx("div",{className:"p-4 border-t border-slate-200 bg-white",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:l,onChange:t=>u(t.target.value),onKeyPress:t=>t.key==="Enter"&&F(),placeholder:"اكتب رسالة... / Type a message...",className:"flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),s.jsx("button",{onClick:F,disabled:!l.trim(),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-semibold",children:"إرسال"})]})})]}):s.jsxs("div",{className:"flex-1 flex items-center justify-center text-slate-500",children:["اختر صديقاً للمحادثة",s.jsx("br",{}),"Select a friend to chat"]})})]})})};export{Q as default};
